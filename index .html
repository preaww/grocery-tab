const SHEET_NAME = "ข้อมูล"; // ชื่อชีตใน Google Sheet
const SPREADSHEET_ID = "17TqRVVqNzS99ejdfYGqaCbTG328zY8scYLW2gKh-PaI"; // เปลี่ยนได้ถ้าคุณใช้ชีตอื่น

function doGet(e) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const action = e.parameter.action;
  const id = e.parameter.id;
  const amount = parseFloat(e.parameter.amount);

  if (action === "get") {
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == id) {
        return ContentService.createTextOutput(JSON.stringify({
          id: data[i][0],
          name: data[i][1],
          total: data[i][2],
          paid: data[i][3]
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
  }

  if (action === "add" && !isNaN(amount)) {
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == id) {
        const current = parseFloat(data[i][2]);
        sheet.getRange(i + 1, 3).setValue(current + amount);
        return ContentService.createTextOutput("success");
      }
    }
  }

  if (action === "paid") {
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == id) {
        sheet.getRange(i + 1, 3).setValue(0); // ล้างยอดเซ็น
        sheet.getRange(i + 1, 4).setValue("จ่ายแล้ว"); // ใส่สถานะ
        return ContentService.createTextOutput("paid");
      }
    }
  }

  return ContentService.createTextOutput("invalid request");
}
